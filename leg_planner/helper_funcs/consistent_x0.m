function x0 = consistent_x0(q0,w0)
%consistent_x0: This functions returns consistent initial conditions for 
%the ntnu leg. 

%% read values:
Q1 = q0(1);
Q2 = q0(2);
Q4 = q0(3);

Qt1 = w0(1);
Qt2 = w0(2);
Qt4 = w0(3);

state_constraints  =zeros(5,2);
state_constraints(1,:) = [-pi   ,pi  ];
state_constraints(2,:) = [-pi   ,1.65];
state_constraints(3,:) = [-2.5  ,1.58];
state_constraints(4,:) = [-1.65 ,pi  ];
state_constraints(5,:) = [-1.51 ,2.5 ];

%% Calculate q:
syms Q3 Q5 real 
assumeAlso(Q3 < state_constraints(3,2) & Q3 > state_constraints(3,1) );
assumeAlso(Q5 < state_constraints(5,2) & Q5 > state_constraints(5,1) );

% length constraint
expr_hq1 = 0.13*sin(Q2) - 0.12*cos(Q4) - 0.12*cos(Q2) - 0.13*sin(Q4) - 0.3*(0.67*cos(Q2) - 0.74*sin(Q2))*(0.24*cos(Q3) - 0.97*sin(Q3)) + 0.3*(0.74*cos(Q2) + 0.67*sin(Q2))*(0.97*cos(Q3) + 0.24*sin(Q3)) - 0.3*(0.67*cos(Q4) + 0.74*sin(Q4))*(0.24*cos(Q5) + 0.97*sin(Q5)) + 0.3*(0.74*cos(Q4) - 0.67*sin(Q4))*(0.97*cos(Q5) - 0.24*sin(Q5)) - 0.09;
expr_hq2 =        0.13*cos(Q2) - 0.13*cos(Q4) + 0.12*sin(Q2) + 0.12*sin(Q4) + 0.3*(0.67*cos(Q2) - 0.74*sin(Q2))*(0.97*cos(Q3) + 0.24*sin(Q3)) + 0.3*(0.74*cos(Q2) + 0.67*sin(Q2))*(0.24*cos(Q3) - 0.97*sin(Q3)) - 0.3*(0.67*cos(Q4) + 0.74*sin(Q4))*(0.97*cos(Q5) - 0.24*sin(Q5)) - 0.3*(0.74*cos(Q4) - 0.67*sin(Q4))*(0.24*cos(Q5) + 0.97*sin(Q5));


eq1 = expr_hq1 == 0;
eq2 = expr_hq2 == 0;


sol1 = solve([eq1;eq2]) ;

Q3 = eval( sol1.Q3 );
Q5 = eval( sol1.Q5 );

%% Calculate qt:
syms Qt3 Qt5 real 
assumeAlso(Qt3 < 32 & Qt3 > -32 );
assumeAlso(Qt5 < 32 & Qt5 > -32);


Hm(1,1:5) = [0, 0.13308156638417232064952600012475*cos(Q2) + 0.12119940877652538357978073690902*sin(Q2) + 0.29977*(0.67333004875847435322100409393897*cos(Q2) - 0.73934203546762400360847777847084*sin(Q2))*(0.97030776516039307644234668259742*cos(Q3) + 0.24187360515245046044263688145293*sin(Q3)) + 0.29977*(0.73934203546762400360847777847084*cos(Q2) + 0.67333004875847435322100409393897*sin(Q2))*(0.24187360515245046044263688145293*cos(Q3) - 0.97030776516039307644234668259742*sin(Q3)), 0.29977*(0.67333004875847435322100409393897*cos(Q2) - 0.73934203546762400360847777847084*sin(Q2))*(0.97030776516039307644234668259742*cos(Q3) + 0.24187360515245046044263688145293*sin(Q3)) + 0.29977*(0.73934203546762400360847777847084*cos(Q2) + 0.67333004875847435322100409393897*sin(Q2))*(0.24187360515245046044263688145293*cos(Q3) - 0.97030776516039307644234668259742*sin(Q3)), 0.12083599892846777157373594491219*sin(Q4) - 0.13341162378892907236505038781615*cos(Q4) - 0.29929*(0.67131110515815428652075524951215*cos(Q4) + 0.74117568771627262425027993231197*sin(Q4))*(0.96952880297333865478037751017837*cos(Q5) - 0.24497734630999076776980416525475*sin(Q5)) - 0.29929*(0.74117568771627262425027993231197*cos(Q4) - 0.67131110515815428652075524951215*sin(Q4))*(0.24497734630999076776980416525475*cos(Q5) + 0.96952880297333865478037751017837*sin(Q5)), - 0.29929*(0.67131110515815428652075524951215*cos(Q4) + 0.74117568771627262425027993231197*sin(Q4))*(0.96952880297333865478037751017837*cos(Q5) - 0.24497734630999076776980416525475*sin(Q5)) - 0.29929*(0.74117568771627262425027993231197*cos(Q4) - 0.67131110515815428652075524951215*sin(Q4))*(0.24497734630999076776980416525475*cos(Q5) + 0.96952880297333865478037751017837*sin(Q5))];
Hm(2,1:5) = [0, 0.12119940877325483974402686726535*cos(Q2) - 0.13308156638776350799702186122886*sin(Q2) + 0.29977*(0.67333004874030466524459370702971*cos(Q2) - 0.73934203548757504442789922904922*sin(Q2))*(0.24187360515245046044263688145293*cos(Q3) - 0.97030776516039307644234668259742*sin(Q3)) - 0.29977*(0.73934203548757504442789922904922*cos(Q2) + 0.67333004874030466524459370702971*sin(Q2))*(0.97030776516039307644234668259742*cos(Q3) + 0.24187360515245046044263688145293*sin(Q3)), 0.29977*(0.67333004874030466524459370702971*cos(Q2) - 0.73934203548757504442789922904922*sin(Q2))*(0.24187360515245046044263688145293*cos(Q3) - 0.97030776516039307644234668259742*sin(Q3)) - 0.29977*(0.73934203548757504442789922904922*cos(Q2) + 0.67333004874030466524459370702971*sin(Q2))*(0.97030776516039307644234668259742*cos(Q3) + 0.24187360515245046044263688145293*sin(Q3)), 0.12083599892520701990505926914921*cos(Q4) + 0.13341162379252917258298793967697*sin(Q4) + 0.29929*(0.67131110514003899947255149527336*cos(Q4) + 0.74117568773627318101659966487205*sin(Q4))*(0.24497734630999076776980416525475*cos(Q5) + 0.96952880297333865478037751017837*sin(Q5)) - 0.29929*(0.74117568773627318101659966487205*cos(Q4) - 0.67131110514003899947255149527336*sin(Q4))*(0.96952880297333865478037751017837*cos(Q5) - 0.24497734630999076776980416525475*sin(Q5)),   0.29929*(0.67131110514003899947255149527336*cos(Q4) + 0.74117568773627318101659966487205*sin(Q4))*(0.24497734630999076776980416525475*cos(Q5) + 0.96952880297333865478037751017837*sin(Q5)) - 0.29929*(0.74117568773627318101659966487205*cos(Q4) - 0.67131110514003899947255149527336*sin(Q4))*(0.96952880297333865478037751017837*cos(Q5) - 0.24497734630999076776980416525475*sin(Q5))];

expr_Hqt = vpa( Hm*[Qt1; Qt2; Qt3; Qt4; Qt5] );

sol2 = solve(expr_Hqt==0) ;

Qt3 = eval( sol2.Qt3 );
Qt5 = eval( sol2.Qt5 );

%% output
q0 = [Q1;Q2;Q3;Q4;Q5];
w0 = [Qt1;Qt2;Qt3;Qt4;Qt5];

x0 = [q0;w0];

%% Comments:
% For C++ consistent initial conditions check:
% C = cell2sym(children(vpa(expr_hq1,2)))
% 
% CQ3 = sum( C(has(C,Q3) ));
% CQ5 = sum( C(has(C,Q5)) );
% Cf  = sum( C(~has(C,[Q3,Q5])) );



end

